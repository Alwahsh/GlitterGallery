/*
 * ext-arrows.js
 *
 * Licensed under the MIT License
 *
 * Copyright(c) 2010 Alexis Deveria
 *
 */
svgEditor.addExtension("Arrows",function(t){function e(t,e){d=!0,g=f+e+"_",m.fw.id=g+"fw",m.bk.id=g+"bk"}function i(){d=!1,g=f,m.fw.id=g+"fw",m.bk.id=g+"bk"}function n(e,i){var n=e.getAttribute(i);if(!n)return null;var a=n.match(/\(\#(.*)\)/);return a&&2===a.length?t.getElem(a[1]):null}function a(t){if($("#arrow_panel").toggle(t),t){var e,i=u[0],n=i.getAttribute("marker-end"),a=i.getAttribute("marker-start"),s=i.getAttribute("marker-mid");n&&a?e="both":n?e="end":a?e="start":s&&(e="mid",-1!=s.indexOf("bk")&&(e="mid_bk")),a||s||n||(e="none"),$("#arrow_list").val(e)}}function s(){var t=u[0];t.removeAttribute("marker-start"),t.removeAttribute("marker-mid"),t.removeAttribute("marker-end")}function r(e,i,n){n=n||g+e;var a=t.getElem(n),s=m[e];if("mid"==i&&(s.refx=5),!a){a=c({element:"marker",attr:{viewBox:"0 0 10 10",id:n,refY:5,markerUnits:"strokeWidth",markerWidth:5,markerHeight:5,orient:"auto",style:"pointer-events:none"}});var r=c({element:"path",attr:{d:s.d,fill:"#000000"}});a.appendChild(r),t.findDefs().appendChild(a)}return a.setAttribute("refX",s.refx),a}function o(){var e=this.value;if(s(),"none"!=e){var i="fw";"mid_bk"==e?(e="mid",i="bk"):"both"==e?(r("bk",e),svgCanvas.changeSelectedAttribute("marker-start","url(#"+m.bk.id+")"),e="end",i="fw"):"start"==e&&(i="bk"),r(i,e),svgCanvas.changeSelectedAttribute("marker-"+e,"url(#"+m[i].id+")"),t.call("changed",u)}}function l(e){var i=e.getAttribute("stroke"),a=["start","mid","end"],s=t.findDefs();$.each(a,function(o,l){var u=n(e,"marker-"+l);if(u){var c=$(u).children().attr("fill"),h=$(u).children().attr("d"),d=null;if(c!==i){var p=$(s).find("marker");if(p.each(function(){var t=$(this).children().attr(["fill","d"]);t.fill===i&&t.d===h&&(d=this)}),!d){var f=u.id,m=-1!==f.indexOf("_fw")?"fw":"bk";d=r(m,l,g+m+p.length),$(d).children().attr("fill",i)}$(e).attr("marker-"+l,"url(#"+d.id+")");var v=!0;$(t.svgcontent).find("line, polyline, path, polygon").each(function(){var t=this;return $.each(a,function(e,i){return $(t).attr("marker-"+i)==="url(#"+u.id+")"?v=!1:void 0}),v?void 0:!1}),v&&$(u).remove()}}})}var u,c=(t.svgcontent,t.addSvgElementFromJson),h=t.nonce,d=t.randomize_ids;svgCanvas.bind("setnonce",e),svgCanvas.bind("unsetnonce",i);var p={en:[{id:"arrow_none",textContent:"No arrow"}],fr:[{id:"arrow_none",textContent:"Sans fl√®che"}]},f="se_arrow_";if(d)var g=f+h+"_";else var g=f;var m={fw:{d:"m0,0l10,5l-10,5l5,-5l-5,-5z",refx:8,id:g+"fw"},bk:{d:"m10,0l-10,5l10,5l-5,-5l5,-5z",refx:2,id:g+"bk"}};return{name:"Arrows",context_tools:[{type:"select",panel:"arrow_panel",title:"Select arrow type",id:"arrow_list",options:{none:"No arrow",end:"----&gt;",start:"&lt;----",both:"&lt;---&gt;",mid:"--&gt;--",mid_bk:"--&lt;--"},defval:"none",events:{change:o}}],callback:function(){$("#arrow_panel").hide(),$("#arrow_list option")[0].id="connector_no_arrow"},addLangData:function(t){return{data:p[t]}},selectedChanged:function(t){u=t.elems;for(var e=u.length,i=["line","path","polyline","polygon"];e--;){var n=u[e];n&&-1!=$.inArray(n.tagName,i)?t.selectedElement&&!t.multiselected?a(!0):a(!1):a(!1)}},elementChanged:function(t){var e=t.elems[0];e&&(e.getAttribute("marker-start")||e.getAttribute("marker-mid")||e.getAttribute("marker-end"))&&l(e)}}});