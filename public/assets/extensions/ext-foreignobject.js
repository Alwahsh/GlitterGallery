/*
 * ext-foreignobject.js
 *
 * Licensed under the Apache License, Version 2
 *
 * Copyright(c) 2010 Jacques Distler 
 * Copyright(c) 2010 Alexis Deveria 
 *
 */
svgEditor.addExtension("foreignObject",function(t){function e(t){var e=$("#fc_rules");e.length||(e=$('<style id="fc_rules"></style>').appendTo("head")),e.text(t?" #tool_topath { display: none !important; }":""),$("#foreignObject_panel").toggle(t)}function i(t){$("#tool_source_save, #tool_source_cancel").toggle(!t),$("#foreign_save, #foreign_cancel").toggle(t)}function n(e){var i=r[0];try{var n=Utils.text2xml('<svg xmlns="'+c+'" xmlns:xlink="'+u+'">'+e+"</svg>");t.sanitizeSvg(n.documentElement),i.parentNode.replaceChild(f.importNode(n.documentElement.firstChild,!0),i),t.call("changed",[i]),svgCanvas.clearSelection()}catch(a){return console.log(a),!1}return!0}function a(){var e=r[0];if(e&&!p){p=!0,i(!0),e.removeAttribute("fill");var n=t.svgToString(e,0);$("#svg_source_textarea").val(n),$("#svg_source_editor").fadeIn(),g(),$("#svg_source_textarea").focus()}}function s(e,i){svgCanvas.changeSelectedAttribute(e,i),t.call("changed",r)}var r,o,l,c=(t.svgcontent,t.addSvgElementFromJson,"http://www.w3.org/2000/svg"),u="http://www.w3.org/1999/xlink",h="http://www.w3.org/2000/xmlns/",d="http://www.w3.org/1998/Math/MathML",p=!1,f=t.svgroot.parentNode.ownerDocument,g=function(){var t=$("#svg_source_container").height()-80;$("#svg_source_textarea").css("height",t)};return{name:"foreignObject",svgicons:"/assets/extensions/foreignobject-icons.xml",buttons:[{id:"tool_foreign",type:"mode",title:"Foreign Object Tool",events:{click:function(){svgCanvas.setMode("foreign")}}},{id:"edit_foreign",type:"context",panel:"foreignObject_panel",title:"Edit ForeignObject Content",events:{click:function(){a()}}}],context_tools:[{type:"input",panel:"foreignObject_panel",title:"Change foreignObject's width",id:"foreign_width",label:"w",size:3,events:{change:function(){s("width",this.value)}}},{type:"input",panel:"foreignObject_panel",title:"Change foreignObject's height",id:"foreign_height",label:"h",events:{change:function(){s("height",this.value)}}},{type:"input",panel:"foreignObject_panel",title:"Change foreignObject's font size",id:"foreign_font_size",label:"font-size",size:2,defval:16,events:{change:function(){s("font-size",this.value)}}}],callback:function(){$("#foreignObject_panel").hide();var t=function(){$("#svg_source_editor").hide(),p=!1,$("#svg_source_textarea").blur(),i(!1)};setTimeout(function(){$("#tool_source_save").clone().hide().attr("id","foreign_save").unbind().appendTo("#tool_source_back").click(function(){p&&(n($("#svg_source_textarea").val())?t():$.confirm("Errors found. Revert to original?",function(e){return e?(t(),void 0):!1}))}),$("#tool_source_cancel").clone().hide().attr("id","foreign_cancel").unbind().appendTo("#tool_source_back").click(function(){t()})},3e3)},mouseDown:function(e){if(e.event,"foreign"==svgCanvas.getMode()){o=!0,l=t.addSvgElementFromJson({element:"foreignObject",attr:{x:e.start_x,y:e.start_y,id:t.getNextId(),"font-size":16,width:"48",height:"20",style:"pointer-events:inherit"}});var i=f.createElementNS(d,"math");i.setAttributeNS(h,"xmlns",d),i.setAttribute("display","inline");var n=f.createElementNS(d,"mi");n.setAttribute("mathvariant","normal"),n.textContent="Φ";var a=f.createElementNS(d,"mo");a.textContent="∪";var s=f.createElementNS(d,"mi");return s.textContent="ℳ",i.appendChild(n),i.appendChild(a),i.appendChild(s),l.appendChild(i),{started:!0}}},mouseUp:function(t){if(t.event,"foreign"==svgCanvas.getMode()&&o){var e=$(l).attr(["width","height"]);return keep=0!=e.width||0!=e.height,svgCanvas.addToSelection([l],!0),{keep:keep,element:l}}},selectedChanged:function(t){r=t.elems;for(var i=r.length;i--;){var n=r[i];n&&"foreignObject"==n.tagName?t.selectedElement&&!t.multiselected?($("#foreign_font_size").val(n.getAttribute("font-size")),$("#foreign_width").val(n.getAttribute("width")),$("#foreign_height").val(n.getAttribute("height")),e(!0)):e(!1):e(!1)}},elementChanged:function(t){t.elems[0]}}});