/*
 * ext-imagelib.js
 *
 * Licensed under the MIT License
 *
 * Copyright(c) 2010 Alexis Deveria
 *
 */
svgEditor.addExtension("imagelib",function(){function t(){$("#imgbrowse_holder").hide()}function e(t){var e=svgCanvas.addSvgElementFromJson({element:"image",attr:{x:0,y:0,width:0,height:0,id:svgCanvas.getNextId(),style:"pointer-events:inherit"}});svgCanvas.clearSelection(),svgCanvas.addToSelection([e]),svgCanvas.setImageURL(t)}function i(t){$("#lib_framewrap, #imglib_opts").css({right:t?200:10}),u||(u=$("<div id=imglib_preview>").css({position:"absolute",top:45,right:10,width:180,bottom:45,background:"#fff",overflow:"auto"}).insertAfter("#lib_framewrap"),h=$("<button disabled>Import selected</button>").appendTo("#imgbrowse").on("click touchend",function(){$.each(o,function(t){var i=this[0],n=this[1];"svg"==i?svgCanvas.importSvgString(n):e(n),svgCanvas.moveSelectedElements(20*t,20*t,!1)}),u.empty(),o=[],$("#imgbrowse_holder").hide()}).css({position:"absolute",bottom:10,right:-10})),u.toggle(t),h.toggle(t)}function n(){var t=$("#imgbrowse");if(t.length)$("#imgbrowse_holder").show();else{$("<div id=imgbrowse_holder><div id=imgbrowse class=toolbar_button>			</div></div>").insertAfter("#svg_docprops"),t=$("#imgbrowse");var e=a.imagelib.select_lib,n=$("<ul id=imglib_opts>").appendTo(t),o=$("<iframe/>").prependTo(t).hide().wrap("<div id=lib_framewrap>"),l=$("<h1>").prependTo(t).text(e).css({position:"absolute",top:0,left:0,width:"100%"}),c=$("<button>"+a.common.cancel+"</button>").appendTo(t).on("click touchend",function(){$("#imgbrowse_holder").hide()}).css({position:"absolute",top:5,right:-10}),u=$("<span>").css({position:"absolute",top:5,left:10}).appendTo(t),h=$("<button hidden>"+a.imagelib.show_list+"</button>").appendTo(u).on("click touchend",function(){o.attr("src","about:blank").hide(),n.show(),l.text(e),h.hide()}).css({"margin-right":5}).hide();$("<select><option value=s>"+a.imagelib.import_single+"</option><option value=m>"+a.imagelib.import_multi+"</option><option value=o>"+a.imagelib.open+"</option></select>").appendTo(u).change(function(){switch(r=$(this).val()){case"s":case"o":i(!1);break;case"m":i(!0)}}).css({"margin-top":10}),c.prepend($.getSvgIcon("cancel",!0)),h.prepend($.getSvgIcon("tool_imagelib",!0)),$.each(s,function(t,e){$("<li>").appendTo(n).text(e.name).on("click touchend",function(){o.attr("src",e.url).show(),l.text(e.name),n.hide(),h.show()}).append("<span>"+e.description+"</span>")})}}var a=svgEditor.uiStrings;$.extend(a,{imagelib:{select_lib:"Select an image library",show_list:"Show library list",import_single:"Import single",import_multi:"Import multiple",open:"Open as new document"}});var s=[{name:"IAN Symbol Libraries",url:"http://ian.umces.edu/symbols/catalog/svgedit/album_chooser.php",description:"Free library of illustrations"}],r="s",o=[],l=!1,c={};window.addEventListener("message",function(i){var n=i.data;if(n){var s,d,p=n.charAt(0);if("{"!=p&&l)return l=!1,void 0;if("|"==p){var f=n.indexOf("|",1),g=n.substr(1,f-1);n=n.substr(f+1),p=n.charAt(0)}switch($("#dialog_box").hide(),p){case"{":l=!1;var m=JSON.parse(n);c[m.id]=m;var v=m.name||"file",b=a.notification.retrieving.replace("%s",v);if("m"!=r)$.process_cancel(b,function(){l=!0,$("#dialog_box").hide()});else{var y=$("<div>"+b+"</div>").data("id",m.id);u.append(y),m.entry=y}return;case"<":s=!0;break;case"d":if(0===n.indexOf("data:image/svg+xml")){var x="data:image/svg+xml;base64,",w=n.substring(x.length);n=svgCanvas.Utils.decode64(w),s=!0;break}if(0===n.indexOf("data:image/")){d=!0;break}default:return"m"!==r?t():c[g].entry.remove(),void 0}switch(r){case"s":s?svgCanvas.importSvgString(n):d&&e(n),t();break;case"m":o.push([s?"svg":"img",n]);var m=c[g];if(s){if(m&&m.name)var _=m.name;else var k=(new DOMParser).parseFromString(n,"text/xml").documentElement,_=$(k).children("title").first().text()||"(SVG #"+n.length+")";m?u.children().each(function(){$(this).data("id")==g&&(m.preview_url?$(this).html('<img src="'+m.preview_url+'">'+_):$(this).text(_),h.removeAttr("disabled"))}):(u.append("<div>"+_+"</div>"),h.removeAttr("disabled"))}else{if(m&&m.preview_url)var _=m.name||"";if(m&&m.preview_url)var y='<img src="'+m.preview_url+'">'+_;else var y='<img src="'+n+'">';m?u.children().each(function(){$(this).data("id")==g&&($(this).html(y),h.removeAttr("disabled"))}):(u.append($("<div>").append(y)),h.removeAttr("disabled"))}break;case"o":if(!s)break;svgEditor.openPrep(function(t){t&&(svgCanvas.clear(),svgCanvas.setSvgString(n))}),t()}}},!0);var u,h;return{svgicons:"/assets/extensions/ext-imagelib.xml",buttons:[{id:"tool_imagelib",type:"app_menu",position:4,title:"Image library",events:{mouseup:n}}],callback:function(){$("<style>").text("				#imgbrowse_holder {					position: absolute;					top: 0;					left: 0;					width: 100%;					height: 100%;					background-color: rgba(0, 0, 0, .5);					z-index: 5;				}								#imgbrowse {					position: absolute;					top: 25px;					left: 25px;					right: 25px;					bottom: 25px;					min-width: 300px;					min-height: 200px;					background: #B0B0B0;					border: 1px outset #777;				}				#imgbrowse h1 {					font-size: 20px;					margin: .4em;					text-align: center;				}				#lib_framewrap,				#imgbrowse > ul {					position: absolute;					top: 45px;					left: 10px;					right: 10px;					bottom: 10px;					background: white;					margin: 0;					padding: 0;				}				#imgbrowse > ul {					overflow: auto;				}				#imgbrowse > div {					border: 1px solid #666;				}				#imglib_preview > div {					padding: 5px;					font-size: 12px;				}				#imglib_preview img {					display: block;					margin: 0 auto;					max-height: 100px;				}				#imgbrowse li {					list-style: none;					padding: .5em;					background: #E8E8E8;					border-bottom: 1px solid #B0B0B0;					line-height: 1.2em;					font-style: sans-serif;					}				#imgbrowse li > span {					color: #666;					font-size: 15px;					display: block;					}				#imgbrowse li:hover {					background: #FFC;					cursor: pointer;					}				#imgbrowse iframe {					width: 100%;					height: 100%;					border: 0;				}			").appendTo("head")}}});