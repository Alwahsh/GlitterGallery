/*
 * ext-markers.js
 *
 * Licensed under the Apache License, Version 2
 *
 * Copyright(c) 2010 Will Schleter 
 *   based on ext-arrows.js by Copyright(c) 2010 Alexis Deveria
 *
 * This extension provides for the addition of markers to the either end
 * or the middle of a line, polyline, path, polygon. 
 * 
 * Markers may be either a graphic or arbitary text
 * 
 * to simplify the coding and make the implementation as robust as possible,
 * markers are not shared - every object has its own set of markers.
 * this relationship is maintained by a naming convention between the
 * ids of the markers and the ids of the object
 * 
 * The following restrictions exist for simplicty of use and programming
 *    objects and their markers to have the same color
 *    marker size is fixed
 *    text marker font, size, and attributes are fixed
 *    an application specific attribute - se_type - is added to each marker element
 *        to store the type of marker
 *        
 * TODO:
 *    remove some of the restrictions above
 *    add option for keeping text aligned to horizontal
 *    add support for dimension extension lines
 *
 */
svgEditor.addExtension("Markers",function(t){function e(e,i){var n=e.getAttribute(i);if(!n)return null;var a=n.match(/\(\#(.*)\)/);return a&&2===a.length?t.getElem(a[1]):null}function i(t){if($("#marker_panel").toggle(t),t){var i,n,a=f[0];$.each(m,function(t,s){var r=e(a,"marker-"+s),o=$("#"+s+"_marker");if(r){if(!r.attributes.se_type)return;i="\\"+r.attributes.se_type.textContent,n=i,"\\textmarker"==i?i=r.lastChild.textContent:o.hide()}else i="\\nomarker",n=i,o.hide();o.val(i),c(s,n)})}}function n(e,i){var n="#ffffff",a="none",s=0,r=t.getElem(e);if(!r&&""!=i&&"\\nomarker"!=i){var o=f[0],l=o.getAttribute("stroke"),c=50,u=50,h="0 0 100 100",d=5,p=5,m=10;if(se_type="\\"==i.substr(0,1)?i.substr(1):"textmarker",y[se_type]){if(r=g({element:"marker",attr:{id:e,markerUnits:"strokeWidth",orient:"auto",style:"pointer-events:none",se_type:se_type}}),"textmarker"!=se_type){var v=g(y[se_type]),b=l;"_o"==se_type.substr(-2)&&(b="none"),v.setAttribute("fill",b),v.setAttribute("stroke",l),v.setAttribute("stroke-width",m),r.appendChild(v)}else{var x=g(y[se_type]);x.textContent=i;var w=x.getBBox(),_=1,k=w;k.x=0,k.y=0,k.width+=2*_,k.height+=2*_,x.setAttribute("x",_),x.setAttribute("y",k.height-_-w.height/4),x.setAttribute("fill",l),c=k.width/2+_,u=k.height/2+_,h=k.x+" "+k.y+" "+k.width+" "+k.height,d=k.width/10,p=k.height/10;var C=g({element:"rect",attr:{x:k.x,y:k.y,width:k.width,height:k.height,fill:n,stroke:a,"stroke-width":s}});r.setAttribute("orient",0),r.appendChild(C),r.appendChild(x)}return r.setAttribute("viewBox",h),r.setAttribute("markerWidth",d),r.setAttribute("markerHeight",p),r.setAttribute("refX",c),r.setAttribute("refY",u),t.findDefs().appendChild(r),r}}}function a(){var i={start_marker:"start",mid_marker:"mid",end_marker:"end"},a=i[this.id],r="marker-"+a,o=this.value,l=f[0],u=e(l,r);if(u&&$(u).remove(),l.removeAttribute(r),""==o&&(o="\\nomarker"),"\\nomarker"==o)return c(a,o),t.call("changed",f),void 0;var h=v+a+"_"+l.id;n(h,o),svgCanvas.changeSelectedAttribute(r,"url(#"+h+")"),"line"==l.tagName&&"mid"==a&&(l=s(l)),t.call("changed",f),c(a,o)}function s(e){if("line"!=e.tagName)return e;var i=e.getAttribute("x1")-0,n=e.getAttribute("x2")-0,a=e.getAttribute("y1")-0,s=e.getAttribute("y2")-0,r=e.id,o=" "+(i+n)/2+","+(a+s)/2+" ",l=g({element:"polyline",attr:{points:i+","+a+o+n+","+s,stroke:e.getAttribute("stroke"),"stroke-width":e.getAttribute("stroke-width"),fill:"none",opacity:e.getAttribute("opacity")||1}});$.each(m,function(t,i){var n="marker-"+i,a=e.getAttribute(n);a&&l.setAttribute(n,e.getAttribute(n))});var c=new t.BatchCommand;return c.addSubCommand(new t.RemoveElementCommand(e,e.parentNode)),c.addSubCommand(new t.InsertElementCommand(l)),$(e).after(l).remove(),svgCanvas.clearSelection(),l.id=r,svgCanvas.addToSelection([l]),t.addCommandToHistory(c),l}function r(t){var i=t.getAttribute("stroke");$.each(m,function(n,a){var s=e(t,"marker-"+a);if(s&&s.attributes.se_type){var r=s.lastElementChild;if(r){var o=r.getAttribute("fill"),l=r.getAttribute("stroke");o&&"none"!=o&&r.setAttribute("fill",i),l&&"none"!=l&&r.setAttribute("stroke",i)}}})}function o(i){$.each(m,function(a,r){var o=v+r+"_"+i.id,l="marker-"+r,c=e(i,l);if(c&&c.attributes.se_type){var u=i.getAttribute(l);if(u){var h=i.id.length,d=u.substr(-h-1,h);if(i.id!=d){var p=$("#"+r+"_marker").attr("value");n(o,p),svgCanvas.changeSelectedAttribute(l,"url(#"+o+")"),"line"==i.tagName&&"mid"==r&&(i=s(i)),t.call("changed",f)}}}})}function l(t,e){$("#"+t+"_marker").val(e),$("#"+t+"_marker").change(),$("#"+t+"_marker")}function c(t,e){"\\"!=e.substr(0,1)&&(e="\\textmarker");var i="#"+b+t+"_"+e.substr(1);svgEditor.setIcon("#cur_"+t+"_marker_list",$(i).children()),$(i).addClass("current").siblings().removeClass("current")}function u(t){var e=$("#"+t+"_marker").val();"\\"==e.substr(0,1)&&(e=""),$.prompt("Enter text for "+t+" marker",e,function(e){e&&l(t,e)})}function h(){var t=this.id.split("_"),e=t[1],i=t[2];t[3]&&(i+="_"+t[3]),"textmarker"!=i?l(e,"\\"+i):u(e)}function d(t,e){var i=x[t];for(var n in i)if(i[n].id==e)return i[n].title;return e}function p(){var t=[];return $.each(m,function(e,i){var n=i+"_marker_list",a=!0;$.each(y,function(e){var s=d("en",e);t.push({id:b+i+"_"+e,svgicon:e,title:s,type:"context",events:{click:h},panel:"marker_panel",list:n,isDefault:a}),a=!1})}),t}var f,g=(t.svgcontent,t.addSvgElementFromJson),m=["start","mid","end"],v="se_marker_",b="mkr_",y={nomarker:{},leftarrow:{element:"path",attr:{d:"M0,50 L100,90 L70,50 L100,10 Z"}},rightarrow:{element:"path",attr:{d:"M100,50 L0,90 L30,50 L0,10 Z"}},textmarker:{element:"text",attr:{x:0,y:0,"stroke-width":0,stroke:"none","font-size":75,"font-family":"serif","text-anchor":"left","xml:space":"preserve"}},forwardslash:{element:"path",attr:{d:"M30,100 L70,0"}},reverseslash:{element:"path",attr:{d:"M30,0 L70,100"}},verticalslash:{element:"path",attr:{d:"M50,0 L50,100"}},box:{element:"path",attr:{d:"M20,20 L20,80 L80,80 L80,20 Z"}},star:{element:"path",attr:{d:"M10,30 L90,30 L20,90 L50,10 L80,90 Z"}},xmark:{element:"path",attr:{d:"M20,80 L80,20 M80,80 L20,20"}},triangle:{element:"path",attr:{d:"M10,80 L50,20 L80,80 Z"}},mcircle:{element:"circle",attr:{r:30,cx:50,cy:50}}},x={en:[{id:"start_marker_list",title:"Select start marker type"},{id:"mid_marker_list",title:"Select mid marker type"},{id:"end_marker_list",title:"Select end marker type"},{id:"nomarker",title:"No Marker"},{id:"leftarrow",title:"Left Arrow"},{id:"rightarrow",title:"Right Arrow"},{id:"textmarker",title:"Text Marker"},{id:"forwardslash",title:"Forward Slash"},{id:"reverseslash",title:"Reverse Slash"},{id:"verticalslash",title:"Vertical Slash"},{id:"box",title:"Box"},{id:"star",title:"Star"},{id:"xmark",title:"X"},{id:"triangle",title:"Triangle"},{id:"mcircle",title:"Circle"},{id:"leftarrow_o",title:"Open Left Arrow"},{id:"rightarrow_o",title:"Open Right Arrow"},{id:"box_o",title:"Open Box"},{id:"star_o",title:"Open Star"},{id:"triangle_o",title:"Open Triangle"},{id:"mcircle_o",title:"Open Circle"}]};return $.each(["leftarrow","rightarrow","box","star","mcircle","triangle"],function(t,e){y[e+"_o"]=y[e]}),{name:"Markers",svgicons:"/assets/extensions/markers-icons.xml",buttons:p(),context_tools:[{type:"input",panel:"marker_panel",title:"Start marker",id:"start_marker",label:"s",size:3,events:{change:a}},{type:"button-select",panel:"marker_panel",title:d("en","start_marker_list"),id:"start_marker_list",colnum:3,events:{change:h}},{type:"input",panel:"marker_panel",title:"Middle marker",id:"mid_marker",label:"m",defval:"",size:3,events:{change:a}},{type:"button-select",panel:"marker_panel",title:d("en","mid_marker_list"),id:"mid_marker_list",colnum:3,events:{change:h}},{type:"input",panel:"marker_panel",title:"End marker",id:"end_marker",label:"e",size:3,events:{change:a}},{type:"button-select",panel:"marker_panel",title:d("en","end_marker_list"),id:"end_marker_list",colnum:3,events:{change:h}}],callback:function(){$("#marker_panel").addClass("toolset").hide()},addLangData:function(t){return{data:x[t]}},selectedChanged:function(t){f=t.elems;for(var e=f.length,n=["line","path","polyline","polygon"];e--;){var a=f[e];a&&-1!=$.inArray(a.tagName,n)?t.selectedElement&&!t.multiselected?i(!0):i(!1):i(!1)}},elementChanged:function(t){var e=t.elems[0];e&&(e.getAttribute("marker-start")||e.getAttribute("marker-mid")||e.getAttribute("marker-end"))&&(r(e),o(e)),changing_flag=!1}}});