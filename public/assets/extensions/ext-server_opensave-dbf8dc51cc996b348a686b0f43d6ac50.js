/*
 * ext-server_opensave.js
 *
 * Licensed under the MIT License
 *
 * Copyright(c) 2010 Alexis Deveria
 *
 */
svgEditor.addExtension("server_opensave",{callback:function(){function t(e){function i(){e.submit(),t(e),$.process_cancel("Uploading...",function(){n=!0,$("#dialog_box").hide()})}e.empty();var a=$('<input type="file" name="svg_file">').appendTo(e);e[0]==o[0]?a.change(function(){svgEditor.openPrep(function(n){return n?(i(),void 0):(t(e),void 0)})}):a.change(function(){i()})}var e="/assets/extensions/filesave.php",i="/assets/extensions/filesave.php";if($('<iframe name="output_frame" src="#"/>').hide().appendTo("body"),svgEditor.setCustomHandlers({save:function(t,i){var n='<?xml version="1.0"?>\n'+i,a=svgCanvas.getDocumentTitle(),s=a.replace(/[^a-z0-9\.\_\-]+/gi,"_");$("<form>").attr({method:"post",action:e,target:"output_frame"}).append('<input type="hidden" name="output_svg" value="'+encodeURI(n)+'">').append('<input type="hidden" name="filename" value="'+s+'">').appendTo("body").submit().remove()},pngsave:function(t,e){var n=e.issues;$("#export_canvas").length||$("<canvas>",{id:"export_canvas"}).hide().appendTo("body");var a=$("#export_canvas")[0];a.width=svgCanvas.contentW,a.height=svgCanvas.contentH,canvg(a,e.svg,{renderCallback:function(){var t=a.toDataURL("image/png");svgEditor.uiStrings;var e="";if(n.length){var s="\n â€¢ ";e+="\n\n"+s+n.join(s)}e.length&&alert(e);var r=svgCanvas.getDocumentTitle(),o=r.replace(/[^a-z0-9\.\_\-]+/gi,"_");$("<form>").attr({method:"post",action:i,target:"output_frame"}).append('<input type="hidden" name="output_png" value="'+t+'">').append('<input type="hidden" name="filename" value="'+o+'">').appendTo("body").submit().remove()}})}}),!window.FileReader){var n=!1,a="extensions/fileopen.php?type=load_svg",s="extensions/fileopen.php?type=import_svg",r="extensions/fileopen.php?type=import_img";svgEditor.processFile=function(t,e){if(n)return n=!1,void 0;if($("#dialog_box").hide(),"import_img"!=e)var i=svgCanvas.Utils.decode64(t);switch(e){case"load_svg":svgCanvas.clear(),svgCanvas.setSvgString(i),svgEditor.updateCanvas();break;case"import_svg":svgCanvas.importSvgString(i),svgEditor.updateCanvas();break;case"import_img":svgCanvas.setGoodImage(t)}};var o=$("<form>");o.attr({enctype:"multipart/form-data",method:"post",action:a,target:"output_frame"});var l=o.clone().attr("action",s),c=o.clone().attr("action",r);t(o),t(l),t(c),$("#tool_open").show().prepend(o),$("#tool_import").show().prepend(l),$("#tool_image").prepend(c)}}});