/*
 * ext-connector.js
 *
 * Licensed under the MIT License
 *
 * Copyright(c) 2010 Alexis Deveria
 *
 */
svgEditor.addExtension("Connector",function(t){function e(t,e){var i=!!e.getAttribute("marker-"+t),n=5*e.getAttribute("stroke-width");return i?n:0}function i(t){var e=$("#connector_rules");e.length||(e=$('<style id="connector_rules"></style>').appendTo("head")),e.text(t?"#tool_clone, #tool_topath, #tool_angle, #xy_panel { display: none !important; }":""),$("#connector_panel").toggle(t)}function n(t,e,i,a,s){var r=t.points,o=m.createSVGPoint();o.x=i,o.y=a,"end"===e&&(e=r.numberOfItems-1);try{r.replaceItem(o,e)}catch(l){for(var c=t.getAttribute("points").split(" "),u=0;u<c.length;u++)u==e&&(c[u]=i+","+a);t.setAttribute("points",c.join(" "))}if(s){var h=r.getItem(0),d=r.getItem(r.numberOfItems-1);n(t,1,(d.x+h.x)/2,(d.y+h.y)/2)}}function a(t,i){for(var a=k.length;a--;){var s=k[a],r=s.connector;s.elem;var l=s.is_start?"start":"end",c=elData(r,l+"_bb");c.x=s.start_x+t,c.y=s.start_y+i,elData(r,l+"_bb",c);var u=s.is_start?"end":"start",h=elData(r,u+"_bb"),d=h.x+h.width/2,p=h.y+h.height/2,f=o(d,p,c,e(l,r));n(r,s.is_start?0:"end",f.x,f.y,!0);var g=o(f.x,f.y,elData(r,u+"_bb"),e(u,r));n(r,s.is_start?"end":0,g.x,g.y,!0)}}function s(t){t||(t=S);var e=$(g).find(C);k=[],e.each(function(){for(var e=elData(this,"c_start"),i=elData(this,"c_end"),n=[y(e),y(i)],a=0;2>a;a++){var s=n[a],r=!1;if($(s).parents().each(function(){-1!==$.inArray(this,t)&&(r=!0)}),s&&s.parentNode){if(-1!==$.inArray(s,t)||r){var o=svgCanvas.getStrokedBBox([s]);k.push({elem:s,connector:this,is_start:0===a,start_x:o.x,start_y:o.y})}}else $(this).remove()}})}function r(t){if(s(t),k.length)for(var i=k.length;i--;){var a=k[i],r=a.connector,l=a.elem;5*r.getAttribute("stroke-width");var c=a.is_start?"start":"end",u=svgCanvas.getStrokedBBox([l]);u.x=a.start_x,u.y=a.start_y,elData(r,c+"_bb",u),elData(r,c+"_off");var h=a.is_start?"end":"start",d=elData(r,h+"_bb"),p=d.x+d.width/2,f=d.y+d.height/2,g=o(p,f,u,e(c,r));n(r,a.is_start?0:"end",g.x,g.y,!0);var m=o(g.x,g.y,elData(r,h+"_bb"),e(h,r));if(n(r,a.is_start?"end":0,m.x,m.y,!0),-1!=navigator.userAgent.indexOf("AppleWebKit")){for(var v=r.points,y=v.numberOfItems,b=Array(y),x=0;y>x;x++){var g=v.getItem(x);b[x]=g.x+","+g.y}r.setAttribute("points",b.join(" "))}}}function o(t,e,i,n){n&&(n-=0,i=$.extend({},i),i.width+=n,i.height+=n,i.x-=n/2,i.y-=n/2);var a,s=i.x+i.width/2,r=i.y+i.height/2,o=t-s,l=e-r,c=Math.abs(l/o);return a=c<i.height/i.width?i.width/2/Math.abs(o):i.height/2/Math.abs(l),{x:s+o*a,y:r+l*a}}function l(){$(g).find("*").each(function(){var t=this.getAttributeNS(f,"connector");if(t){this.setAttribute("class",C.substr(1));var e=t.split(" "),i=svgCanvas.getStrokedBBox([y(e[0])]),n=svgCanvas.getStrokedBBox([y(e[1])]);$(this).data("c_start",e[0]).data("c_end",e[1]).data("start_bb",i).data("end_bb",n),svgCanvas.getEditorNS(!0)}})}var c,u,h,d,p,f,g=t.svgcontent,m=t.svgroot,v=t.getNextId,y=t.getElem,b=t.addSvgElementFromJson,x=t.selectorManager,w=svgEditor.curConfig,_=!1,k=[],C=".se_connector",S=[];elData=$.data;var T={en:[{id:"mode_connect",title:"Connect two objects"}],fr:[{id:"mode_connect",title:"Connecter deux objets"}]};return function(){var t=svgCanvas.groupSelectedElements;svgCanvas.groupSelectedElements=function(){return svgCanvas.removeFromSelection($(C).toArray()),t.apply(this,arguments)};var e=svgCanvas.moveSelectedElements;svgCanvas.moveSelectedElements=function(){svgCanvas.removeFromSelection($(C).toArray());var t=e.apply(this,arguments);return r(),t},f=svgCanvas.getEditorNS()}(),{name:"Connector",svgicons:"/assets/images/conn.svg",buttons:[{id:"mode_connect",type:"mode",icon:"/assets/images/cut.png",title:"Connect two objects",includeWith:{button:"#tool_line",isDefault:!1,position:1},events:{click:function(){svgCanvas.setMode("connector")}}}],addLangData:function(t){return{data:T[t]}},mouseDown:function(t){var e=t.event;c=t.start_x,u=t.start_y;var i=svgCanvas.getMode();if("connector"==i){if(_)return;var n=e.target,a=$(n).parents();if(-1!=$.inArray(g,a)){var r=$(n).closest("foreignObject");d=r.length?r[0]:n;var o=svgCanvas.getStrokedBBox([d]),l=o.x+o.width/2,p=o.y+o.height/2;_=!0,h=b({element:"polyline",attr:{id:v(),points:l+","+p+" "+l+","+p+" "+c+","+u,stroke:"#"+w.initStroke.color,"stroke-width":d.stroke_width&&0!=d.stroke_width?d.stroke_width:w.initStroke.width,fill:"none",opacity:w.initStroke.opacity,style:"pointer-events:none"}}),elData(h,"start_bb",o)}return{started:!0}}"select"==i&&s()},mouseMove:function(t){var i=svgCanvas.getZoom();t.event;var s=t.mouse_x/i,r=t.mouse_y/i,l=s-c,d=r-u,p=svgCanvas.getMode();if("connector"==p&&_){3*h.getAttribute("stroke-width");var f=o(s,r,elData(h,"start_bb"),e("start",h));c=f.x,u=f.y,n(h,0,f.x,f.y,!0),n(h,"end",s,r,!0)}else if("select"==p){for(var g=S.length;g--;){var m=S[g];m&&elData(m,"c_start")&&(svgCanvas.removeFromSelection([m]),svgCanvas.getTransformList(m).clear())}k.length&&a(l,d)}},mouseUp:function(t){var i=svgCanvas.getZoom(),a=t.event,s=(t.mouse_x/i,t.mouse_y/i,a.target);if("connector"==svgCanvas.getMode()){var r=$(s).closest("foreignObject");r.length&&(s=r[0]);var l=$(s).parents();if(s==d)return _=!0,{keep:!0,element:null,started:_};if(-1===$.inArray(g,l))return $(h).remove(),_=!1,{keep:!1,element:null,started:_};p=s;var m=d.id,v=p.id,y=m+" "+v,b=v+" "+m,w=$(g).find(C).filter(function(){var t=this.getAttributeNS(f,"connector");return t==y||t==b?!0:void 0});if(w.length)return $(h).remove(),{keep:!1,element:null,started:!1};var k=svgCanvas.getStrokedBBox([p]),S=o(c,u,k,e("start",h));return n(h,"end",S.x,S.y,!0),$(h).data("c_start",m).data("c_end",v).data("end_bb",k),f=svgCanvas.getEditorNS(!0),h.setAttributeNS(f,"se:connector",y),h.setAttribute("class",C.substr(1)),h.setAttribute("opacity",1),svgCanvas.addToSelection([h]),svgCanvas.moveToBottomSelectedElement(),x.requestSelector(h).showGrips(!1),_=!1,{keep:!0,element:h,started:_}}},selectedChanged:function(t){if($(g).find(C).length){"connector"==svgCanvas.getMode()&&svgCanvas.setMode("select"),S=t.elems;for(var e=S.length;e--;){var n=S[e];n&&elData(n,"c_start")?(x.requestSelector(n).showGrips(!1),t.selectedElement&&!t.multiselected?i(!0):i(!1)):i(!1)}r()}},elementChanged:function(t){var e=t.elems[0];if(e&&"svg"==e.tagName&&"svgcontent"==e.id&&(g=e,l()),e&&(e.getAttribute("marker-start")||e.getAttribute("marker-mid")||e.getAttribute("marker-end"))){var i=e.getAttribute("marker-start"),n=e.getAttribute("marker-mid"),a=e.getAttribute("marker-end");if(h=e,$(e).data("start_off",!!i).data("end_off",!!a),"line"==e.tagName&&n){var s=e.getAttribute("x1")-0,o=e.getAttribute("x2")-0,c=e.getAttribute("y1")-0,u=e.getAttribute("y2")-0,d=e.id,p=" "+(s+o)/2+","+(c+u)/2+" ",f=b({element:"polyline",attr:{points:s+","+c+p+o+","+u,stroke:e.getAttribute("stroke"),"stroke-width":e.getAttribute("stroke-width"),"marker-mid":n,fill:"none",opacity:e.getAttribute("opacity")||1}});$(e).after(f).remove(),svgCanvas.clearSelection(),f.id=d,svgCanvas.addToSelection([f]),e=f}}if(e.getAttribute("class")==C.substr(1)){var i=y(elData(e,"c_start"));r([i])}else r()},toolButtonStateUpdate:function(t){t.nostroke&&$("#mode_connect").hasClass("tool_button_current")&&clickSelect(),$("#mode_connect").toggleClass("disabled",t.nostroke)}}});